{% liquid
  assign product = closest.product
  assign block_settings = block.settings
  assign selected_variant = product.selected_or_first_available_variant

  if settings.currency_code_enabled_product_cards
    assign price_min = product.price_min | money_with_currency
  else
    assign price_min = product.price_min | money
  endif

  if product.price_varies
    assign display_price = 'content.price_from' | t: price: price_min
  endif

  assign has_swatches_only = false

  if product.options.size == 1
    assign first_product_option_value = product.options_with_values.first.values.first

    if first_product_option_value.swatch != blank
      assign has_swatches_only = true
    endif
  endif
%}

<product-price
  class="text-right {{ block_settings.type_preset | default: 'h6' }} spacing-style"
  data-block-id="{{ block.id }}"
  data-product-id="{{ product.id }}"
  style="
    {% render 'spacing-style', settings: block_settings %}
    --product-price-width: 100%;
  "
  {{ block.shopify_attributes }}
>
  {% if product.price_varies and has_swatches_only == false and price_min != blank %}
    <span class="price">{{ display_price }}</span>
  {% else %}
    <div class="price-wrapper-with-discount">
      {% render 'price',
        show_unit_price: true,
        show_sale_price_first: block_settings.show_sale_price_first,
        product_resource: product
      %}

      {%- if selected_variant.compare_at_price > selected_variant.price -%}
        {%- assign discount = selected_variant.compare_at_price | minus: selected_variant.price -%}
        {%- assign discount_percentage = discount | times: 100.0 | divided_by: selected_variant.compare_at_price | round -%}
        <span class="discount-percentage">
          ({{ discount_percentage }}% OFF)
        </span>
      {%- endif -%}
    </div>
  {% endif %}
</product-price>

{% # theme-check-disable %}
{% stylesheet %}
  .price-wrapper-with-discount {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    flex-wrap: wrap;
    gap: 8px;
  }

  .discount-percentage {
    display: inline-block;
    color: #d32f2f;
    font-weight: 600;
    font-size: 0.9em;
    white-space: nowrap;
    animation: discount-pulse 2s ease-in-out infinite;
    transform-origin: center;
  }

  @keyframes discount-pulse {
    0%, 100% {
      transform: scale(1);
      opacity: 1;
    }
    50% {
      transform: scale(1.05);
      opacity: 0.85;
    }
  }

  /* Subtle slide-in animation on page load */
  @keyframes discount-slide-in {
    from {
      opacity: 0;
      transform: translateX(10px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  .discount-percentage {
    animation: discount-slide-in 0.4s ease-out, discount-pulse 2s ease-in-out 0.5s infinite;
  }
{% endstylesheet %}
{% # theme-check-enable %}

{% schema %}
{
  "name": "t:names.product_price",
  "tag": null,
  "settings": [
    {
      "type": "paragraph",
      "content": "t:content.resource_reference_product_price"
    },
    {
      "type": "paragraph",
      "content": "t:content.edit_price_in_theme_settings"
    },
    {
      "type": "checkbox",
      "id": "show_sale_price_first",
      "label": "t:settings.show_sale_price_first",
      "default": true
    },
    {
      "type": "select",
      "id": "type_preset",
      "label": "t:settings.type_preset",
      "options": [
        {
          "value": "",
          "label": "t:options.default"
        },
        {
          "value": "paragraph",
          "label": "t:options.paragraph"
        },
        {
          "value": "h1",
          "label": "t:options.h1"
        },
        {
          "value": "h2",
          "label": "t:options.h2"
        },
        {
          "value": "h3",
          "label": "t:options.h3"
        },
        {
          "value": "h4",
          "label": "t:options.h4"
        },
        {
          "value": "h5",
          "label": "t:options.h5"
        },
        {
          "value": "h6",
          "label": "t:options.h6"
        }
      ],
      "info": "t:info.edit_presets_in_theme_settings"
    }
  ]
}
{% endschema %}
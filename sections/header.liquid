{%- comment -%}
  Dynamic Navbar Section
  Implements the navbar described in NAVBAR_IMPLEMENTATION.md
{%- endcomment -%}

{%- style -%}
  #shopify-section-{{ section.id }} {
    --navbar-height: 70px;
    --navbar-radius: 24px;
    --navbar-padding: 12px;
    --navbar-gap: 24px;
    --navbar-logo-size: {{ section.settings.logo_width }}px;
    --navbar-bg: {{ section.settings.color_scheme.settings.background | default: 'var(--color-background)' }};
    --navbar-text: {{ section.settings.color_scheme.settings.text | default: 'var(--color-foreground)' }};
    
    position: relative;
    z-index: 10;
  }

  .navbar {
    display: flex;
    align-items: center;
    background: var(--navbar-bg);
    color: var(--navbar-text);
    border-radius: var(--navbar-radius);
    padding: 0 var(--navbar-padding);
    min-height: var(--navbar-height);
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    margin: 1rem auto;
    max-width: var(--page-width, 1400px);
    width: calc(100% - 2rem);
    justify-content: space-between;
    transition: transform 220ms ease-in-out, opacity 220ms ease-in-out;
    will-change: transform, opacity;
  }

  .navbar__logo {
    display: flex;
    align-items: center;
    justify-content: center;
    width: var(--navbar-logo-size);
    height: var(--navbar-logo-size);
    border-radius: 50%;
    overflow: hidden;
    flex-shrink: 0;
    
    /* Mobile: Center logo absolutely */
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    z-index: 2;
  }
  
  .navbar__logo img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .navbar__list {
    display: none;
    list-style: none;
    margin: 0;
    padding: 0;
    gap: var(--navbar-gap);
    justify-content: flex-start;
  }

  .navbar__item {
    position: relative;
  }

  .navbar__link {
    text-decoration: none;
    color: inherit;
    font-weight: 500;
    padding: 0.5rem;
    display: block;
    white-space: nowrap;
  }

  .navbar__submenu {
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%) translateY(10px);
    background: var(--navbar-bg);
    min-width: 200px;
    border-radius: 12px;
    box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    opacity: 0;
    visibility: hidden;
    transition: all 0.2s ease;
    list-style: none;
    padding: 0.5rem;
    z-index: 20;
  }

  .navbar__submenu--active {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(0);
  }

  .navbar__submenu-link {
    display: block;
    padding: 0.5rem 1rem;
    text-decoration: none;
    color: inherit;
    border-radius: 8px;
  }

  .navbar__submenu-link:hover {
    background: rgba(0,0,0,0.05);
  }

  .navbar__actions {
    display: flex;
    align-items: center;
    gap: 1rem;
    z-index: 2;
  }

  .navbar__action {
    color: inherit;
    text-decoration: none;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
  }

  .navbar__mobile-toggle {
    display: block;
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.5rem;
    color: inherit;
    z-index: 2;
  }

  .navbar__mobile-menu {
    position: fixed;
    inset: 0;
    background: var(--navbar-bg);
    z-index: 100;
    transform: translateX(-100%);
    transition: transform 0.3s ease;
    padding: 2rem;
    display: flex;
    flex-direction: column;
  }

  .navbar__mobile-menu--open {
    transform: translateX(0);
  }

  .navbar__mobile-list {
    list-style: none;
    padding: 0;
    margin: 2rem 0;
    overflow-y: auto;
  }

  .navbar__mobile-item {
    border-bottom: 1px solid rgba(0,0,0,0.1);
  }

  .navbar__mobile-link {
    display: block;
    padding: 1rem 0;
    font-size: 1.2rem;
    text-decoration: none;
    color: inherit;
  }

  .navbar__mobile-submenu {
    display: none;
    list-style: none;
    padding-left: 1rem;
    background: rgba(0,0,0,0.02);
  }

  .navbar__mobile-submenu--open {
    display: block;
  }

  .navbar__mobile-submenu-link {
    display: block;
    padding: 0.5rem 0;
    text-decoration: none;
    color: inherit;
    opacity: 0.8;
  }

  .navbar__mobile-expand {
    float: right;
    background: none;
    border: none;
    padding: 1rem;
    cursor: pointer;
  }

  /* At tablet and up, place logo in the visual centre and use grid layout
     Use 768px breakpoint so the logo recenters earlier and more predictably */
  @media screen and (min-width: 768px) {
    .navbar {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      justify-content: unset;
      align-items: center;
    }

    /* Ensure the logo is placed in the exact centre of the grid and not
       absolutely positioned (use !important to override earlier inline rules
       or higher-specificity selectors from other files). */
    .navbar__logo {
      position: static !important;
      left: auto !important;
      transform: none !important;
      grid-column: 2;
      justify-self: center;
      align-self: center;
    }

    .navbar__list {
      display: flex;
      grid-column: 1;
      margin-left: 0;
      padding-left: calc(var(--navbar-padding) / 2);
    }

    .navbar__mobile-toggle {
      display: none;
    }

    .navbar__actions {
      grid-column: 3;
      justify-self: end;
    }
  }

  /* Hide the navbar on scroll-down and reveal on single scroll-up when using scroll-up sticky mode */
  header-component[sticky='scroll-up'][data-scroll-direction='down'] .navbar {
    transform: translateY(calc(-1 * (var(--navbar-height) + 12px)));
    opacity: 0;
    pointer-events: none;
  }

  header-component[sticky='scroll-up'][data-scroll-direction='up'] .navbar,
  header-component[sticky='scroll-up'][data-scroll-direction='none'] .navbar {
    transform: translateY(0);
    opacity: 1;
    pointer-events: auto;
  }

  /* If an existing header menu is used, ensure it aligns to the left column */
  .navbar__menu {
    grid-column: 1;
    display: block;
    align-self: center;
  }

  /* Make sure the header-menu list respects the navbar gap and spacing */
  .navbar__menu .menu-list__list {
    display: flex;
    gap: var(--navbar-gap);
    margin: 0;
    padding: 0;
    align-items: center;
  }
{%- endstyle -%}

<script src="{{ 'navbar.js' | asset_url }}" defer="defer"></script>

{%- capture menu_json -%}
[
  {%- for link in linklists[section.settings.menu].links -%}
    {
      "id": "{{ link.handle }}",
      "label": "{{ link.title | escape }}",
      "url": "{{ link.url }}",
      "children": [
        {%- for child in link.links -%}
          {
            "id": "{{ child.handle }}",
            "label": "{{ child.title | escape }}",
            "url": "{{ child.url }}"
          }{%- unless forloop.last -%},{%- endunless -%}
        {%- endfor -%}
      ]
    }{%- unless forloop.last -%},{%- endunless -%}
  {%- endfor -%}
]
{%- endcapture -%}

{%- capture header_menu -%}
  {%- content_for 'block', type: '_header-menu', id: 'header-menu' -%}
{%- endcapture -%}

<navbar-component
  class="navbar color-{{ section.settings.color_scheme }}"
  data-menu-data='{{ menu_json }}'
  {{ section.shopify_attributes }}
>
  <!-- Mobile Toggle -->
  <button class="navbar__mobile-toggle" ref="mobileMenuButton" aria-label="Menu">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </button>

  <!-- Logo -->
  <a href="{{ routes.root_url }}" class="navbar__logo">
    {%- if section.settings.logo != blank -%}
      {{ section.settings.logo | image_url: width: section.settings.logo_width | image_tag: loading: 'eager', width: section.settings.logo_width, height: section.settings.logo_width }}
    {%- else -%}
      <span class="h4">{{ shop.name }}</span>
    {%- endif -%}
  </a>

  <!-- Desktop Menu: prefer existing _header-menu block for quick navigation (mega menu). Falls back to JS-rendered list -->
  {%- unless header_menu == blank -%}
    <div class="navbar__menu desktop:visible">
      {{ header_menu }}
    </div>
  {%- else -%}
    <ul class="navbar__list" ref="navList"></ul>
  {%- endunless -%}

  <!-- Actions -->
  <div class="navbar__actions">
    {%- if section.settings.show_search -%}
      <a href="{{ routes.search_url }}" class="navbar__action" aria-label="Search">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
      </a>
    {%- endif -%}
    
    {%- if section.settings.show_account and shop.customer_accounts_enabled -%}
      <a href="{%- if customer -%}{{ routes.account_url }}{%- else -%}{{ routes.account_login_url }}{%- endif -%}" class="navbar__action" aria-label="Account">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
      </a>
    {%- endif -%}

    {%- if section.settings.show_cart -%}
      <a href="{{ routes.cart_url }}" class="navbar__action" aria-label="Cart">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="9" cy="21" r="1"></circle>
          <circle cx="20" cy="21" r="1"></circle>
          <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
        </svg>
      </a>
    {%- endif -%}
  </div>

  <!-- Mobile Menu -->
  <div class="navbar__mobile-menu" ref="mobileMenu">
    <div style="display: flex; justify-content: flex-end;">
      <button class="navbar__mobile-toggle" onclick="this.closest('navbar-component').querySelector('[ref=mobileMenuButton]').click()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <ul class="navbar__mobile-list"></ul>
  </div>
</navbar-component>

{% schema %}
{
  "name": "Dynamic Navbar",
  "settings": [
    {
      "type": "link_list",
      "id": "menu",
      "label": "Menu",
      "default": "main-menu"
    },
    {
      "type": "image_picker",
      "id": "logo",
      "label": "Logo"
    },
    {
      "type": "range",
      "id": "logo_width",
      "min": 40,
      "max": 100,
      "step": 2,
      "unit": "px",
      "label": "Logo width",
      "default": 60
    },
    {
      "type": "checkbox",
      "id": "show_search",
      "label": "Show search",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_cart",
      "label": "Show cart",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_account",
      "label": "Show account",
      "default": true
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-1"
    }
  ],
  "presets": [
    {
      "name": "Dynamic Navbar"
    }
  ]
}
{% endschema %}